<!DOCTYPE html> 
<html> 
<!-- The following code has been developed by students and/or researchers of the Freshman Research Initiative DIY Diagnostics Stream at The University of Texas at Austin.  This code is shared for demonstration purposes and should not be considered a product -- it is for entertainment purposes only.  Any user of this code does so at their own risk. Members of the DIY Stream, FRI, and The University of Texas system are not liable for anything related to this code.
 
THIS CODE SHOULD NOT BE USED TO DIAGNOSE ANY KIND OF MEDICAL CONDITION.
 
 
Authors in chronological order of contribution:
Tim Riedel
Sofia Williams
Presley Jones
 
Further Information:
http://diystream.cns.utexas.edu/

Research Educator:
Timothy Riedel
triedel@utexas.edu
 
Brief Description of Goal of Code:
The Goal of this code is to help individuals self diagnose if they have hearing loss. This code should not be a definitive diagnosis, but could help people seek help should they need it. 
 
Known Issues:
Need to ask user for data collection and adjust app visuals
-->

   <head> 
      
	   <title>Hello World</title>  
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <link rel="stylesheet" href="w3.css">
      <link rel="stylesheet" href="w3-colors-flat.css">
   </head> 


<script>
	
	var docMod = document.lastModified;
       alert("This file last modified  " + docMod);
       console.log("This file last modified  " + docMod);
	
	var dB = 0.091;
	var pageNum = 0;
	
	// String[][] arr = new String[13][2]; //Collumns are hz, which ear, and at what dB level it is heard by user
	var arr = [];
	  
    function initArray(){   //Sets starting values for array
    
	for (var i = 0; i < 14; i++)
    {
    	arr[i] = [];
    }    
    
	    
    var hz = 125;
    var ear = -1;
    for (r=0; r <14; r++)
    {
    	if ((r%2) == 0 && r != 0)
        	{
            	hz *= 2;
            }
        	for (c = 0; c<=1; c++)
        {
        if (c == 0)
            {
            	arr[r][c] = hz;
            }
        if (c == 1)
            {
            	arr [r][c] = ear;
		ear *= -1;
            }
            
            }
        }
    }

	
	
	//imported decibel functions
	function dBFSToGain(dbfs) {  
  	return Math.pow(10, dbfs / 20);
	}
	 
	
	function decibel(freq, ear){
	let audioCtx = new AudioContext()

	// Create nodes
	let osc = audioCtx.createOscillator()
	let gain = audioCtx.createGain()

	// Set parameters
	osc.frequency.value = freq
	gain.gain.value = dB
	
	// Schedule parameter changes
	
	// Drop to -12 dBFS at ~1s
	gain.gain.setValueAtTime(dB, 1 - 0.03);
	gain.gain.linearRampToValueAtTime(dBFSToGain(-70), 3) //changed gain 
		
	//Creating Stereo Panner to Output on L Headphone
	var panNode = audioCtx.createStereoPanner()
	panNode.pan.value = ear
	
	//Connect graph
	osc.connect(gain)
	gain.connect(panNode)
	panNode.connect(audioCtx.destination) 
	
	// Schedule start and stop
	//osc.start()
		osc.start(0)
		/* panNode.gain.exponentialRampToValueAtTime(
 		0.00001, context.currentTime + 5) */
	osc.stop(audioCtx.currentTime + 2)
	}
	
function getSofter(){
		/* var softerDecibel = parseInt(gain.gain.value) - 0.091;
		gain.gain.value = softerDecibel; */
       // dB = dB - 0.091;
	if (dB > 0.091){
        dB -= 0.091;
        }
        else
        dB = 0.091;
	}
	
function getLouder(){
		/* var louderDecibel = parseInt(gain.gain.value) + 0.091;
		gain.gain.value = louderDecibel; */
       // dB = dB + 0.091;
	if (dB >= 1){
        dB = 1;
        }
        else
        dB += 0.091;
	}
	
function showdB(){
    alert("Decibel level is:" + dB.toString());
    console.log("Decibel level is:" + dB.toString());
    }	
	
function collectData(){
    	arr[pageNum][2] = dB * 110;
        dB = 0.091;
        pageNum++;
    }
    
function makeAudiogram() {
	var leftEar = [];
	var rightEar = [];
	
	for (var i = 0; i < 14; i+=2)
	{
		leftEar.push(
			{
				x: arr[i][0],
				y: arr[i][2]
			});
	}
	for (var i = 1; i < 14; i+=2)
	{
		rightEar.push(
			{
				x: arr[i][0],
				y: arr[i][2]
			});
	}
	
	var chart = new CanvasJS.Chart("chartContainer", {
	title:{
		text: "Audiogram"
	},
    axisX:{
  title : "Frequency (Hz)",
  suffix: "Hz",
  logarithmic: true,
  logarithmBase: 125,
  minimum: 110,
  maximum: 8000,
 },

	axisY:[{
		title: "Volume",
		includeZero: true,
        reversed: true,
		suffix: "dB",
		minimum: 0,
 		maximum: 110,
	},
	{
		title: "Hearing Loss",
		includeZero: true,
	}],
	toolTip: {
		shared: true
	},
	legend: {
		cursor: "pointer",
		itemclick: toggleDataSeries
	},
	data: [{
		type: "line",
		name: "Left Ear",
		color: "#369EAD",
		showInLegend: true,
        axisYIndex: 2,
		dataPoints: leftEar
	},
	{
		type: "line",
		name: "Right Ear",
		color: "#C24642",
		axisYIndex: 2,
		showInLegend: true,
		dataPoints: rightEar
	}]
});
chart.render();

function toggleDataSeries(e) {
	if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
		e.dataSeries.visible = false;
	} else {
		e.dataSeries.visible = true;
	}
	e.chart.render();
}

}
	
	
</script>
<style>	
.body {
     margin: 0em;
}

.page {
    width: 100vw;
    height: 100vh;
    position: fixed;
    top: 0;
    left: -100vw;
    overflow-y: auto;
    z-index: 0;
    background-color: hsl(0,0%,100%);
}

  .page:target {
    left: 0vw;
    z-index: 1;
}
</style>
<style>	
	.slidecontainer {
  width: 100%;
}

.slider {
  -webkit-appearance: none;
  width: 100%;
  height: 50px;
  background: #d3d3d3;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

.slider:hover {
  opacity: 1;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 50px;
  height: 50px;
  background: #4CAF50;
  cursor: pointer;
}

.slider::-moz-range-thumb {
  width: 50px;
  height: 50px;
  background: #4CAF50;
  cursor: pointer;
}
</style>
</head>
	<body>
<div id="header" class="w3-container w3-flat-peter-river">
	<h1>Audiogram Test</h1>
</div>
	
<div id="content" class="w3-container">
	<p>This audiogram exam will help find out if you may have hearing loss and help to tell you the extent of your hearing loss. In order to perform this exam, 
	follow all of the instructions listed below: </p>
	<p> 1. Try to take this test in as quiet of an environment as possible for optimal results. </p>
	<p> 2. This exam must be used with headphones in order to detect changes in the left/right ear. Use the highest quality of headphones that you have to take this test. </p>
	<p> 3. Turn your device's volume to the maximum volume setting. The app will not play sounds as loud as the device's full amplitude, but uses this as a scale to calibrate accurate decibel outputs. </p>
	 <a href="#125L" class="w3-btn w3-grey w3-round" onclick= "initArray();" > Get Started </a>
	<br> 
	<br>
	<br>
	<br>
	<br> 
	<br>
	<br>
	<br>
	<br>
	<br>
	<p style="color:black;font-size:12px;">The following code has been developed by students and/or researchers of the Freshman Research Initiative DIY Diagnostics Stream at The University of Texas at 		Austin.  This code is shared for demonstration purposes and should not be considered a product -- it is for entertainment purposes only. Any user of this code 			does so at their own risk. Members of the DIY Stream, FRI, and The University of Texas system are not liable for anything related to this code.</p>
	<p style="color:black;font-size:12px;">THIS CODE SHOULD NOT BE USED TO DIAGNOSE ANY KIND OF MEDICAL CONDITION.</p>

	
	
	
	
<!--125DB LEFT EAR-->
<div class="page" id="125L">
	<div id="header" class="w3-container w3-flat-peter-river">
		<h1>125 HZ Part 1</h1>
	</div>
	
<div id="content" class="w3-container">
	
<br>
<p> Click the buttons below to hear the frequency. Starting at "1", click the next button until you can hear a noise. Once you hear the first noise, do not keep increasing the volume level and answer the next questions. If you need to hear the noise again, simply click the buttons again </p>
	<button onclick="decibel(125,-1); showdB(); " class="w3-btn w3-black"> Play Sound </button>
	<br>
	<br>
	<button onclick="getSofter();" class="w3-btn w3-black"> Softer </button>
	<button onclick="getLouder();" class="w3-btn w3-black"> Louder </button>
	<br>
	<br>
	<br>
<p> Click the button below to move to the next page and collect your data. </p> 
	<br>
	<a href="#125R" onclick= "collectData();" class="w3-btn w3-black"> Next </a> <!--button to take user to the next page-->	
    	</div>
	
	

<!--125DB RIGHT EAR-->
<div class="page" id="125R">
<div id="header" class="w3-container w3-flat-peter-river">
		<h1>125 HZ Part 2</h1>
	</div>
	
    	<div id="content" class="w3-container">
 
<br>
<p> Click the buttons below to hear the frequency. Starting at "1", click the next button until you can hear a noise. Once you hear the first noise, do not keep increasing the volume level and answer the next questions. If you need to hear the noise again, simply click the buttons again </p>
	<button onclick="decibel(125,1); showdB(); " class="w3-btn w3-black"> Play Sound </button>
	<br>
	<br>
	<button onclick="getSofter();" class="w3-btn w3-black"> Softer </button>
	<button onclick="getLouder();" class="w3-btn w3-black"> Louder </button>
	<br>
	<br>
	<br>
<p> Click the button below to move to the next page and collect your data. </p> 
	<br>	
	<a href="#500L" onclick= "collectData();" class="w3-btn w3-black"> Next </a> <!--button to take user to the next page-->	
	</div>	


    
        
        
<!--500DB LEFT EAR-->
<div class="page" id="500L">
<div id="header" class="w3-container w3-flat-peter-river">
		<h1>500 HZ Part 1</h1>
	</div>
	
    	<div id="content" class="w3-container">
		
<br>
<p> Click the buttons below to hear the frequency. Starting at "1", click the next button until you can hear a noise. Once you hear the first noise, do not keep increasing the volume level and answer the next questions. If you need to hear the noise again, simply click the buttons again </p>
	<button onclick="decibel(500,-1); showdB(); " class="w3-btn w3-black"> Play Sound </button>
	<br>
	<br>
	<button onclick="getSofter();" class="w3-btn w3-black"> Softer </button>
	<button onclick="getLouder();" class="w3-btn w3-black"> Louder </button>
	<br>
	<br>
	<br>
<p> Click the button below to move to the next page and collect your data. </p> 
	<br>
	<a href="#Results" onclick= "makeAudiogram();" class="w3-btn w3-black"> Next </a> <!--button to take user to the next page-->	
    	</div>
	
	
<div class="page" id="Results">
<div id="header" class="w3-container w3-flat-peter-river">
		<h1>Results</h1>
	</div>
	
    	<div id="content" class="w3-container">
	<br>

<div id="chartContainer" style="height: 300px; width: 100%;"></div>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
		

</div>
	<footer class="w3-bottom w3-container w3-flat-peter-river">
	<p>DIY DIAGNOSTICS!</p>
</footer>

</body>
</html>
